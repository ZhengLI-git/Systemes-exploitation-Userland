/* 
 * Auteur(s):Zheng LI
 *
 *  Cet application chiffre un mot de passe entré au clavier. 
 */

#include <sys/time.h>
#include <stdio.h>
#include <termios.h>
#include <stdlib.h>
#define _XOPEN_SOURCE	/* Voir le man 3 crypt */
#include <unistd.h>
#include <crypt.h> 
#define ECHOFLAGS (ECHO | ECHOE | ECHOK | ECHONL)
#include <errno.h>

#define BUFSIZE 64
char *c_key =
    "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789./";

char getkey() {
  long nb;
  struct timeval tp;
  gettimeofday(&tp, NULL);
  srandom(tp.tv_sec + tp.tv_usec);//prendre la date en microsecondes 
  nb = random()%64;  
  return  c_key[nb];

}

int setsilent(struct termios *initial_term) {
  int r;
  struct termios term;
  if(tcgetattr(STDIN_FILENO,&term)==-1){
     perror("Cannot get the attribution of the terminal");
     return 1;
  }
  term.c_lflag &=~ECHOFLAGS;//Écho désactivé
  r=tcsetattr(STDIN_FILENO,TCSAFLUSH,&term);
  if(r==-1 && r==EINTR){
     perror("Cannot set the attribution of the terminal");
     return 1;
  }
  return 0;
}

int restaure_term(struct termios *initial_term) {
  int r;
  struct termios term;
  if(tcgetattr(STDIN_FILENO,&term)==-1){
      perror("Cannot get the attribution of the terminal");
      return 1;
  }
  term.c_lflag|=ECHOFLAGS;//Écho ouvert
  r=tcsetattr(STDIN_FILENO,TCSAFLUSH,&term);
  if(r==-1 && r==EINTR){
      perror("Cannot set the attribution of the terminal");
      return 1;
  }

  return 0;
}

/*  a utiliser au 8.4 */
char *get_pass() {
  static char buf[BUFSIZE];
  char c;
  int i = 0;

  while ((c = getchar()) != '\n') {
    buf[i++] = c;
    putchar('*');
  }

  buf[i] = '\0';
  putchar('\n');
  return buf;
}


int main() {

  //char buf[BUFSIZE], 
  char *s, *pwd;
  struct termios initial_term;
  char slat[2];
  slat[0] = getkey();
  slat[1] = getkey();
  
  //printf("key = %s\n", key);

  printf("Tapez votre mot de passe : ");
  setsilent(&initial_term);
  s = get_pass();
 // s = fgets(buf, BUFSIZE, stdin);
  pwd = crypt(s,slat);
  printf("Mot de passe chiffre : %s\n", pwd);
  
  restaure_term(&initial_term);
  exit(EXIT_SUCCESS);
}
