/*
 * Auteur(s):Zheng LI
 *
 * Cet programme refait ce que fait la commande "ls". Il donne des
 * informnations sur les caracteristiques de fichiers dont le nom est passe
 * en parametre.
 *
 * Utilisation de la primitive stat(2) et de la fonction getpwuid(3).
 */

#include <sys/types.h>
#include <sys/stat.h>
#include <pwd.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

/* Petite fonction qui se charge d'envoyer les messages d'erreur
   et qui ensuite "suicide" le processus. */

void erreur_grave(char *msg) {
  perror(msg);
  exit(EXIT_FAILURE);
}

/* Fonction principale (fournie avec erreur(s?)) */

int main(int argc, char **argv) {
  struct stat status, *buffer;
  struct passwd *info;// Trouver les informations pertinentes de l'utilisateur via l'ID utilisateur et renvoyer ses données dans la structure passwd pour 1.2
  int r;
  buffer = &status;//Initialize buffer pour 1.1

  r = stat(argv[1], buffer);
  if (r < 0)
    erreur_grave("Stat");


//1.1 output: Fichier 1_1-status:  mode: 81FD  Taille: 8912  Proprietaire: 1000 
  printf("Fichier %s:  mode: %X  Taille: %ld  Proprietaire: %d\n",
  	argv[1], buffer->st_mode, buffer->st_size, buffer->st_uid);

//1.2 output: Fichier 1_1-status:  mode: 81FD  Taille: 8912  Proprietaire: zheng
  info = getpwuid(buffer->st_uid);//for 1.2 pour de vrai
  printf("Fichier %s:  mode: %X  Taille: %ld  Proprietaire: %s\n",
  	argv[1], buffer->st_mode, buffer->st_size, info->pw_name);

//1.3 output: Fichier 1_1-status:  mode: 81FD  Taille: 8912  Proprietaire: zheng
//Answer: getpwuid () écrit son résultat dans une variable statique et renvoie le pointeur dans ce tampon. Lorsque je l'appelle une deuxième fois, il écrase la valeur précédente, mais c'était toujours zheng car 1000 est en fait l'ID utilisateur de zheng. Donc, le deuxième appel n'a rien changé
  getpwuid(1000);//pour de faux
  printf("Fichier %s:  mode: %X  Taille: %ld  Proprietaire: %s\n",
  	argv[1], buffer->st_mode, buffer->st_size, info->pw_name);
//1.4 answer: Si une erreur se produit, elle renvoie un pointeur nul et définit la valeur de errno, l'utilisateur peut afficher les informations d'erreur en fonction de la fonction perror 

  exit(EXIT_SUCCESS);
}
