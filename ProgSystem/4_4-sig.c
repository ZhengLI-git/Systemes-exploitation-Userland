/* 
 * Auteur(s):Zheng LI
 *
 *
 * Il émette un message numéro 1 ou un message numéro 2 sur réception du signal INT (lorsque l’on 
 * tape [Control-C]). Le choix du message émis se fait par commutation commandée par le signal 
 * QUIT (lorsque l’on tape [Control-\]).
 * Utilisation de sigaction
 */

#include <signal.h>
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <string.h>

struct sigaction *sig_avant;		

void hdl_quit(int sig){
  sigaction(SIGINT, sig_avant, sig_avant);

}  
void hdl_int1(int sig){
  printf("message 1\n");

}
void hdl_int2(int sig){
  printf("message 2\n");

}

void travail() {
  /* Je travaille tres intensement !    */
  /* Ne cherchez pas a comprendre ;-) */
  /* Il n'y a rien a modifier ici     */
  const char msg[] = "-\\|/";
  const int sz = strlen(msg);
  int i = 0;

  for (;;) {
    write(STDOUT_FILENO, "\r", 1);
    usleep(100000);
    write(STDOUT_FILENO, " => ", 4);
    write(STDOUT_FILENO, &msg[i++], 1);
    if (i == sz) i = 0;
  }
}
void travail() __attribute__((noreturn));
/* Petit raffinement pour le compilateur: cette fonction ne termine pas */


int main() {
  static struct sigaction actquit, actint1, actint2;
  actquit.sa_handler = hdl_quit;
  actint1.sa_handler = hdl_int1;
  actint2.sa_handler = hdl_int2;
  sig_avant = &actint2;
  sigaction(SIGQUIT,&actquit,NULL);
  sigaction(SIGINT,&actint1,NULL);

  printf("PID: %d\n", getpid());
  
  travail();
}
